{% extends "navigate.html" %} {% block mainbody %}

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title></title>
    <meta charset="utf-8" />
    <script src="/static/js/echarts.js"></script>

</head>
<title>å®ä½“æŸ¥è¯¢</title>
<div class="container">
    <div class="row">
    <!--head start-->
    <div class="col-md-12">
            <ol class="breadcrumb">
                <li><i class="fa fa-home"></i><a href="\search_entity">Home</a></li>
                <li><i class="fa fa-share-alt" aria-hidden="true"></i>å®ä½“æŸ¥è¯¢</li>
            </ol>
    </div>
    <div class = "col-md-12">
        <div class="panel panel-default ">
            <header class = "panel-heading">
                æŸ¥è¯¢æ¡ä»¶ğŸ‰ï¼š
            </header>
            <div class = "panel-body">
                <!--æœç´¢æ¡†-->
                <form method="post" action="/search_entity">
                    {{ form.csrf_token }}
                    <div>
                        <div class="input-group">
                            {{ form.select(class="form-control", style="width:150px;margin:10px 10px; border-radius:5px") }}
                            {{ form.entity(class="form-control", placeholder="è¯·è¾“å…¥å®ä½“åç§°" ,style="width:500px;margin:10px 10px; border-radius:15px")}}
                            {{ form.submit(class="btn btn-primary", style="background-color:#4592fe; margin: 10px 10px;") }}
                        </div>
                        {% for message in form.entity.errors %}
                            <small style="color:#f9002f">{{ message }}</small><br>
                        {% endfor %}
                    </div>
                </form>
            </div>
        </div>

    </div>
    <p>
        <div class = "col-md-12">
            {% if not ctx %}
                <div class="panel panel-default">
                    <header class ="panel-heading">
                        <h2>æ•°æ®åº“ä¸­æš‚æœªæ·»åŠ è¯¥å®ä½“</h2>
                    </header>
                </div>
            {% endif %}
        </div>
    </p>
<!--å®ä½“å…³ç³»æŸ¥è¯¢-->
{% if entityRelation %}
    <!-- Echart Domå¯¹è±¡ï¼ˆå®ä½“å…³ç³»ï¼‰ -->
    <div class = "col-md-12">
        <div class="panel panel-default ">
            <header class="panel-heading">
                å…³ç³»å›¾ :
            </header>
            <div class = "panel-body ">
                <div id="graph" style="width: 90%;height:600px;"></div>
            </div>
        </div>
    </div>
{% endif %}
{% if entityRelation %}
<div class = "col-md-12">
    <div class="panel panel-default">
    <header class="panel-heading">
        å…³ç³»åˆ—è¡¨ :
    </header>
        <div class = "panel-body">
            <table class = "table" data-paging =  "true" data-sorting="true"></table>
        </div>
    </div>
</div>
{% endif %}
</div>
</div>
{% if entityRelation %}
<script src="/static/js/jquery.min.js"></script>
<script type="text/javascript">
        // åŸºäºæŸ¥è¯¢ç»“æœï¼šåˆå§‹åŒ–Dataå’ŒLinksåˆ—è¡¨ï¼Œç”¨äºEchartså¯è§†åŒ–è¾“å‡º
        var entityRelation = [ {{ entityRelation|safe }} ] ;
        var data = [] ;
        var links = [] ;
        var node = {} ;
        //é€šè¿‡ç±»å‹è¿›è¡ŒåŒºåˆ†å®ä½“1
        var str = entityRelation[0][0]['entity1']['Name']
        //var str = eval('{{ ctx|safe }}')
        //å®ä½“1ï¼šå¾…æŸ¥è¯¢çš„å¯¹è±¡
        node['name'] = str;
        node['draggable'] = true ;
        var id = 0;
        node['id'] = id.toString() ;
        data.push(node) ;

        //å®ä½“2ï¼šæŸ¥è¯¢å¹¶è½¬å‚¨åˆ°dataä¸­ï¼Œå–äºŒè€…è¾ƒå°çš„å€¼
        var maxDisPlayNode = 25 ;   //æœ€å¤§å±•ç¤ºæ•°ç›®
        for( var i = 0 ;i < Math.min(maxDisPlayNode,entityRelation[0].length) ; i++ ){
            node = {} ;

            node['name'] = entityRelation[0][i]['entity2']['Name'] ;
            node['draggable'] = true ;   //æ˜¯å¦å…è®¸æ‹–æ‹½
            //æ˜¯å¦URLï¼šåŒºåˆ†ç±»å‹
            if('url' in entityRelation[0][i]['entity2']){
                node['category'] = 1 ;
            }
            else{
                node['category'] = 2 ;
            }
            id = i + 1
            node['id'] = id.toString();
            var flag = 1 ;
            relationTarget = id.toString() ;
            for(var j = 0 ; j<data.length ;j++){
                if(data[j]['name'] === node['name']){
                    flag = 0 ;
                    relationTarget = data[j]['id']  ;
                    break ;
                }
            }
            relation = {}
            relation['source'] = 0 ;
            relation['target'] = relationTarget ;
            relation['category'] = 0 ;

            if(flag === 1){
                data.push(node) ;
                relation['value'] = entityRelation[0][i]['rel']['type'] ;
                relation['symbolSize'] = 10
                links.push(relation) ;
            }
            else{
                maxDisPlayNode += 1 ;
                for(var j = 0; j<links.length ;j++){
                    if(links[j]['target'] === relationTarget){
                        links[j]['value'] = links[j]['value']+" | "+entityRelation[0][i]['rel']['type']
                        break ;
                    }
                }

            }
        }
        //åŸºäºè¡¨æ ¼çš„å±•ç¤º++
        tableData = []
        for (var i = 0 ; i < entityRelation[0].length ; i++){
            relationData = {} ;

            relationData['entity1'] = str ;
            relationData['relation'] = entityRelation[0][i]['rel']['type'] ;
            relationData['entity2'] = entityRelation[0][i]['entity2']['Name'] ;
            tableData.push(relationData) ;
        }
        jQuery(function(){
            $('.table').footable({
            "columns": [{"name":"entity1",title:"Entity1"} ,
                      {"name":"relation",title:"Relation"},
                      {"name":"entity2",title:"Entity2"}],
            "rows": tableData
            });
        });
        //åŸºäºè¡¨æ ¼çš„å±•ç¤º--

        // åŸºäºå‡†å¤‡å¥½çš„æ•°æ®ï¼šDataå’ŒLinksï¼Œè®¾ç½®Echartså‚æ•°
        var myChart = echarts.init(document.getElementById('graph'));
        option = {
            title: {
                text: ''
            },                //æ ‡é¢˜
            tooltip: {},                           //æç¤ºæ¡†é…ç½®
            animationDurationUpdate: 1500,
            animationEasingUpdate: 'quinticInOut',
            label: {
                normal: {
                    show: true,
                    textStyle: {
                        fontSize: 12
                    },
                }
            },                          //èŠ‚ç‚¹ä¸Šçš„æ ‡ç­¾
            legend: {
                x: "center",
                show: false
            },
            series: [
                {
                    type: 'graph',                //ç³»åˆ—ï¼š
                    layout: 'force',
                    symbolSize: 45,
                    focusNodeAdjacency: true,
                    roam: true,
                    edgeSymbol: ['none', 'arrow'],
                    categories: [{
                        name: 'Bank',
                        itemStyle: {
                            normal: {
                                color: "#009800",
                            }
                        }
                    }, {
                        name: 'Serise',
                        itemStyle: {
                            normal: {
                                color: "#4592FF",
                            }
                        }
                    }, {
                        name: 'Instance',
                        itemStyle: {
                            normal: {
                                color: "#C71585",
                            }
                        }
                    }],
                    label: {
                        normal: {
                            show: true,
                            textStyle: {
                                fontSize: 12,
                            },
                        }
                    },               //èŠ‚ç‚¹æ ‡ç­¾æ ·å¼
                    force: {
                        repulsion: 1000
                    },
                    edgeSymbolSize: [4, 50],
                    edgeLabel: {
                        normal: {
                            show: true,
                            textStyle: {
                                fontSize: 10
                            },
                            formatter: "{c}"
                        }
                    },           //è¾¹æ ‡ç­¾æ ·å¼
                    data: data,                 //èŠ‚ç‚¹
                    links: links,               //èŠ‚ç‚¹é—´çš„å…³ç³»
                    lineStyle: {
                        normal: {
                            opacity: 0.9,
                            width: 1.3,
                            curveness: 0,
                            color:"#262626"
                        }
                    }            // è¿æ¥çº¿çš„é£æ ¼
                }
            ]
        };
        myChart.setOption(option);
</script>
{% endif %}
{% endblock %}